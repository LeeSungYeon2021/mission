<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="wemb.mission.plan.dao.PlanDao">

	<!-- 일정 등록 -->
	<insert id="planInsert"
		parameterType="wemb.mission.plan.vo.Plan">
		INSERT INTO
		TB_PLAN
		VALUES
		(PLAN_SEQ.NEXTVAL,TO_CHAR(SYSDATE,'yyyymmddhh24miss'),#{plan_start_date},#{plan_end_date},TO_CHAR(SYSDATE,'yyyymmddhh24miss'),#{plan_title},#{plan_content},#{plan_state})
	</insert>

	<!-- 일정 상태 카운트 조회 -->
	<select id="planState" resultType="java.util.HashMap"
		parameterType="string">
		SELECT

		TMP.DAYS AS DAYS,
		COUNT(*) AS STATE_COUNT


		FROM
		( SELECT
		TO_CHAR(TO_DATE(#{startDay},'YYYYMMDD')+LEVEL-1,'YYYYMMDD') AS DAYS
		FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]>
		TO_DATE(#{endDay}, 'YYYYMMDD') - TO_DATE(#{startDay},'YYYYMMDD')+1)TMP
		,
		TB_PLAN TP

		WHERE

		(
		TMP.DAYS = SUBSTR(TP.PLAN_START_DATE,1,8)

		OR
		TMP.DAYS = SUBSTR(TP.PLAN_END_DATE,1,8)
		)
		AND PLAN_STATE ='Y'
		GROUP BY TMP.DAYS
	</select>

	<!-- 해당 월 일정 조회 -->
	<select id="planSelect" resultType="wemb.mission.plan.vo.Plan"
		parameterType="string">

		SELECT
		TP.PLAN_ENROLL_DATE AS PLAN_ENROLL_DATE,
		TP.PLAN_START_DATE AS
		PLAN_START_DATE,
		TP.PLAN_END_DATE AS PLAN_END_DATE,
		TP.PLAN_NO AS
		PLAN_NO,
		TP.PLAN_TITLE AS PLAN_TITLE,
		TP.PLAN_STATE AS PLAN_STATE,
		TMP.DAYS AS DAYS,
		RANK() OVER(PARTITION BY TMP.DAYS ORDER BY PLAN_STATE
		DESC,PLAN_ENROLL_DATE)
		AS DAY_RANK
		FROM
		(SELECT
		TO_CHAR(TO_DATE(#{startDay},'YYYYMMDD')+LEVEL-1,'YYYYMMDD') AS DAYS
		FROM DUAL CONNECT BY LEVEL <![CDATA[<=]]>
		TO_DATE(#{endDay}, 'YYYYMMDD') - TO_DATE(#{startDay},'YYYYMMDD')+1)TMP
		,
		TB_PLAN TP

		WHERE

		(TMP.DAYS = SUBSTR(TP.PLAN_START_DATE,1,8) OR TMP.DAYS
		=
		SUBSTR(TP.PLAN_END_DATE,1,8))

		GROUP BY

		TMP.DAYS,
		TP.PLAN_TITLE,
		TP.PLAN_NO,
		TP.PLAN_ENROLL_DATE,
		TP.PLAN_START_DATE,
		TP.PLAN_END_DATE,
		TP.PLAN_STATE

		ORDER BY TP.PLAN_ENROLL_DATE,DAYS
	</select>

	<!-- 월별 카운트 조회 -->
	<select id="planMonthCount" resultType="int"
		parameterType="string">

		SELECT COUNT(*) AS MONTHCOUNT

		FROM TB_PLAN

		WHERE

		PLAN_START_DATE <![CDATA[>=]]>
		#{startDay} AND PLAN_START_DATE <![CDATA[<=]]>
		#{endDay}

	</select>

	<!-- 일별 카운트 조회 -->
	<select id="planDayCount" resultType="java.util.HashMap"
		parameterType="string">
		SELECT

		TMP.DAYS AS DAYS,
		COUNT(*) AS CONTENT_COUNT

		FROM

		(SELECT
		TO_CHAR(TO_DATE(#{startDay},'YYYYMMDD')+LEVEL-1,'YYYYMMDD') AS
		DAYS

		FROM DUAL
		CONNECT BY LEVEL <![CDATA[<=]]>
		TO_DATE(#{endDay}, 'YYYYMMDD') - TO_DATE(#{startDay},'YYYYMMDD')+1)TMP
		,TB_PLAN TP

		WHERE

		TMP.DAYS = SUBSTR(TP.plan_start_date,1,8)

		OR

		TMP.DAYS =
		SUBSTR(TP.plan_END_date,1,8)
		GROUP BY TMP.DAYS
		ORDER BY DAYS
	</select>

	<!-- 일정 상세보기 -->
	<select id="planView" parameterType="int"
		resultType="wemb.mission.plan.vo.Plan">
		SELECT
		
		PLAN_NO AS PLAN_NO,
		PLAN_ENROLL_DATE AS PLAN_ENROLL_DATE,		
		PLAN_START_DATE AS PLAN_START_DATE,
		PLAN_END_DATE AS PLAN_END_DATE,		
		PLAN_UPDATE_DATE AS PLAN_UPDATE_DATE,
		PLAN_TITLE AS PLAN_TITLE,		
		PLAN_CONTENT AS PLAN_CONTENT,
		PLAN_STATE AS PLAN_STATE

		FROM
		TB_PLAN

		WHERE PLAN_NO = #{no}
	</select>

	<!-- 일별 일정 리스트 조회 -->
	<select id="planDayList" parameterType="string"
		resultType="wemb.mission.plan.vo.Plan">
		SELECT

		PLAN_NO AS PLAN_NO,
		PLAN_ENROLL_DATE AS
		PLAN_ENROLL_DATE,
		PLAN_START_DATE AS PLAN_START_DATE,
		PLAN_END_DATE AS
		PLAN_END_DATE,
		PLAN_UPDATE_DATE AS PLAN_UPDATE_DATE,
		PLAN_TITLE AS
		PLAN_TITLE,
		PLAN_CONTENT AS PLAN_CONTENT,
		PLAN_STATE AS PLAN_STATE

		FROM
		TB_PLAN

		WHERE
		(
		SUBSTR(PLAN_START_DATE,1,8) = #{searchDay}

		OR

		SUBSTR(PLAN_END_DATE,1,8) = #{searchDay}
		)

		ORDER BY PLAN_START_DATE ASC
	</select>
	<!-- 일정 수정 -->
	<update id="planUpdate"
		parameterType="wemb.mission.plan.vo.Plan">
		UPDATE TB_PLAN SET

		PLAN_START_DATE = #{plan_start_date} ,
		PLAN_END_DATE = #{plan_end_date} ,
		PLAN_UPDATE_DATE =
		TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),
		PLAN_TITLE = #{plan_title} ,
		PLAN_CONTENT = #{plan_content},
		PLAN_STATE = #{plan_state}

		WHERE PLAN_NO
		= #{plan_no}
	</update>

	<!-- 일정 삭제 -->
	<delete id="planDelete" parameterType="_int">
		DELETE FROM TB_PLAN WHERE
		PLAN_NO = #{plan_no}
	</delete>
	
	
	<select id="planCal" parameterType="string" resultType="wemb.mission.plan.vo.PlanCal">
	SELECT MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '1', LEVEL)) sun
	,MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '2', LEVEL)) mon
	, MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '3', LEVEL)) the
	, MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '4', LEVEL)) wed
	, MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '5', LEVEL)) thu
	, MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '6', LEVEL)) fri
	, MIN (DECODE (TO_CHAR (YM + LEVEL - 1, 'D'), '7', LEVEL)) sat
	FROM (SELECT TO_DATE(#{day},'YYYYMM') YM FROM DUAL)
	CONNECT BY LEVEL <![CDATA[<=]]> LAST_DAY (YM) - YM + 1
	GROUP BY TRUNC (YM + LEVEL, 'IW')
	ORDER BY sat 
	</select>
</mapper>